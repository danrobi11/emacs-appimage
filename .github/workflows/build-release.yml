name: Build Static Emacs Binary

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential git wget autoconf automake libtool pkg-config make texinfo \
            libncurses-dev libgnutls28-dev libxml2-dev libjansson-dev libpcre2-dev \
            libsqlite3-dev zlib1g-dev libcap-dev libffi-dev liblzma-dev libidn2-dev \
            libtasn1-dev nettle-dev libunistring-dev libgpg-error-dev libgcrypt20-dev \
            libssl-dev

      - name: Clone Emacs source
        run: |
          git clone --depth 1 --branch master https://github.com/emacs-mirror/emacs.git emacs-src

      - name: Configure and build mostly-static Emacs
        working-directory: emacs-src
        run: |
          ./autogen.sh
          ./configure \
            --prefix=/tmp/emacs-static/usr \
            --without-x \
            --without-xpm --without-jpeg --without-png --without-gif --without-tiff \
            --without-toolkit-scroll-bars --without-x-toolkit \
            --without-gsettings --without-dbus --without-gconf --without-selinux \
            --without-sound --without-imagemagick --without-xwidgets \
            --with-gnutls \
            --with-modules=ifavailable \
            --without-compress-install \
            --enable-static \
            --disable-shared \
            LDFLAGS="-static" \
            CFLAGS="-O2 -g -fno-omit-frame-pointer"
          make bootstrap -j$(nproc)
          make -j$(nproc)
          make install

      - name: Verify the built binary
        run: |
          /tmp/emacs-static/usr/bin/emacs --version
          file /tmp/emacs-static/usr/bin/emacs
          ldd /tmp/emacs-static/usr/bin/emacs || true

      - name: Prepare artifact directory
        run: |
          mkdir -p artifact
          cp /tmp/emacs-static/usr/bin/emacs artifact/emacs-static
          cp -r /tmp/emacs-static/usr/share/emacs artifact/share || true

      - name: Upload static Emacs artifact
        uses: actions/upload-artifact@v4
        with:
          name: emacs-static-binary
          path: artifact/
          retention-days: 14
          compression-level: 6
