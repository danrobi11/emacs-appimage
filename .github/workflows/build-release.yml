name: Build Dynamic Terminal Emacs Binary

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential git wget autoconf automake libtool pkg-config make texinfo \
            libncurses-dev libgnutls28-dev libxml2-dev libjansson-dev libpcre2-dev \
            libsqlite3-dev zlib1g-dev libcap-dev libffi-dev liblzma-dev libidn2-dev \
            libtasn1-dev nettle-dev libunistring-dev libgpg-error-dev libgcrypt20-dev \
            libssl-dev

      - name: Clone Emacs source
        run: |
          git clone --depth 1 --branch master https://github.com/emacs-mirror/emacs.git emacs-src

      - name: Configure and build dynamic Emacs
        working-directory: emacs-src
        run: |
          ./autogen.sh
          autoreconf -fi
          ./configure \
            --build=x86_64-pc-linux-gnu \
            --host=x86_64-pc-linux-gnu \           # â† Add this line
            --prefix=/tmp/emacs-dynamic/usr \
            --without-x \
            --without-xpm --without-jpeg --without-png --without-gif --without-tiff \
            --without-toolkit-scroll-bars --without-x-toolkit \
            --without-gsettings --without-dbus --without-gconf --without-selinux \
            --without-sound --without-imagemagick --without-xwidgets \
            --with-gnutls \
            --with-modules=ifavailable \
            --without-compress-install \
            --without-lcms2 \
            --with-pdumper=yes \
            CFLAGS="-O2 -g -fno-omit-frame-pointer"
          make bootstrap -j$(nproc)
          make -j$(nproc)
          mkdir -p /tmp/emacs-dynamic/usr/libexec/emacs/31.0.50/x86_64-pc-linux-gnu
          src/temacs -Q --batch --eval "(dump-emacs-portable \"/tmp/emacs-dynamic/usr/libexec/emacs/31.0.50/x86_64-pc-linux-gnu/emacs.pdmp\")"
          make install

      - name: Verify the built binary
        run: |
          /tmp/emacs-dynamic/usr/bin/emacs --version
          file /tmp/emacs-dynamic/usr/bin/emacs
          ldd /tmp/emacs-dynamic/usr/bin/emacs

      - name: Prepare artifact directory
        run: |
          mkdir -p artifact/bin
          cp /tmp/emacs-dynamic/usr/bin/emacs artifact/bin/emacs
          mkdir -p artifact/lib
          cp /lib/x86_64-linux-gnu/libtinfo.so.6 \
             /lib/x86_64-linux-gnu/libncursesw.so.6 \
             /usr/lib/x86_64-linux-gnu/libgnutls.so.30 \
             /usr/lib/x86_64-linux-gnu/libnettle.so.8 \
             /usr/lib/x86_64-linux-gnu/libhogweed.so.6 \
             /usr/lib/x86_64-linux-gnu/libunistring.so.2 \
             artifact/lib/ 2>/dev/null || true
          mkdir -p artifact/share
          cp -r /tmp/emacs-dynamic/usr/share/emacs artifact/share || true
          mkdir -p artifact/libexec/emacs/31.0.50/x86_64-pc-linux-gnu
          cp -r /tmp/emacs-dynamic/usr/libexec/emacs/31.0.50/x86_64-pc-linux-gnu/* \
             artifact/libexec/emacs/31.0.50/x86_64-pc-linux-gnu/ || true
      - name: Upload dynamic Emacs artifact
        uses: actions/upload-artifact@v4
        with:
          name: emacs-dynamic-binary
          path: artifact/
          retention-days: 14
          compression-level: 6
